#!/bin/bash

# Directorio de trabajo
cd /tmp/src

# Instalar dependencias del sistema
dnf install -y gcc-c++ python3.12-devel wget unzip && \
    dnf clean all

# Descargar e instalar libtorch
if [ ! -d "${LIBTORCH_PATH}" ]; then
    wget -q https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-2.3.0%2Bcpu.zip -O libtorch.zip && \
    unzip libtorch.zip -d /opt && \
    rm libtorch.zip
fi

# Instalar dependencias de Python
python3.12 -m ensurepip && \
    python3.12 -m pip install --upgrade pip && \
    python3.12 -m pip install -r requirements.txt

# Instalar pybind11
python3.12 -m pip install pybind11

# Compilar el m√≥dulo C++
g++ -shared -fPIC -o googlenet.so main.cpp \
    -I/usr/local/lib/python3.12/site-packages/pybind11/include \
    -I${LIBTORCH_PATH}/include \
    -I${LIBTORCH_PATH}/include/torch/csrc/api/include \
    -I/usr/include/python3.12 \
    -L${LIBTORCH_PATH}/lib \
    -ltorch -ltorch_cpu -lc10 \
    -std=c++17 \
    -Wl,-rpath,${LIBTORCH_PATH}/lib

# Copiar los archivos necesarios al directorio de runtime
mkdir -p /opt/app-root/src
cp googlenet.so /opt/app-root/src/
cp main.py /opt/app-root/src/
cp googlenet.pt /opt/app-root/src/
cp imagenet_classes.txt /opt/app-root/src/

# Configurar permisos
chmod +x /opt/app-root/src/main.py